<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#58CC02">
  <title>LinguaKids - Chinese</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@600;700&family=Quicksand:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Quicksand', Arial, sans-serif;
      background: linear-gradient(135deg,#e0eaff 0%,#f6f0ff 100%);
      margin: 0;
      padding: 0;
      position: relative;
      min-height: 100vh;
    }
    
    #app { 
      max-width: 1000px; 
      margin: auto; 
      padding: 15px; 
      position: relative;
    }
    
    h2 { 
      text-align: center; 
      color: #58cc02; 
      font-family: 'Baloo 2', cursive; 
    }
    
    .sub-container, .initials-grid, .finals-grid, .numbers-grid {
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
      gap: 15px; 
      margin-top: 20px;
    }
    
    .sub-card, .initial-card, .final-card, .number-card {
      background: white; 
      padding: 15px; 
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05); 
      text-align: center;
      cursor: pointer; 
      transition: 0.3s;
    }
    
    .sub-card:hover, .initial-card:hover, .final-card:hover, .number-card:hover {
      transform: translateY(-5px); 
      box-shadow: 0 8px 15px rgba(0,0,0,0.1);
    }
    
    .main-char { 
      font-size: 2rem; 
      font-weight: bold; 
      color: #58cc02; 
    }
    
    .small-char { 
      font-size: 1.2rem; 
      color: #1cb0f6; 
    }
    
    .example { 
      margin-top: 5px; 
      font-size: 1rem; 
    }
    
    .btn {
      background: linear-gradient(to right, #58cc02, #1cb0f6);
      border: none; 
      color: white; 
      padding: 8px 20px; 
      border-radius: 50px;
      font-family: 'Baloo 2', cursive; 
      cursor: pointer; 
      margin: 10px 5px;
      display: inline-block;
    }
    
    .btn:active { 
      transform: scale(0.96); 
    }
    
    .lesson-controls {
      display: flex; 
      justify-content: center; 
      gap: 10px; 
      margin-top: 15px;
      flex-wrap: wrap;
    }
    
    canvas {
      border: 2px solid #ccc; 
      border-radius: 12px; 
      background: #fff;
      display: block; 
      margin: 15px auto;
    }
    
    @media (max-width: 600px) {
      .main-char { font-size: 1.5rem; } 
      .small-char { font-size: 1rem; }
      .example { font-size: 0.9rem; }
    }
    
    .lesson-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      margin-top: 20px;
    }
    
    .lesson-container .main-char {
      font-size: 3rem;
    }
    
    .lesson-container .example {
      font-size: 1.3rem;
      margin: 10px 0;
    }
    
    .trace-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 10px 0;
    }

    .clear-btn {
      background: #ff6b6b;
      padding: 5px 15px;
      font-size: 0.9rem;
      border-radius: 8px;
      margin-top: 8px;
    }
    
    .clear-btn:hover {
      background: #ff5252;
    }
    
    .sub-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      text-align: center;
      cursor: pointer;
      transition: 0.3s;
      word-wrap: break-word;
      overflow-wrap: break-word;
      white-space: normal;
    }

    .sub-card h3 {
      font-size: 1.1rem;
      margin: 5px 0;
    }

    .sub-card p {
      font-size: 0.9rem;
      margin: 0;
      line-height: 1.2;
    }
    
    @media (max-width: 600px) {
      .sub-container {
        grid-template-columns: repeat(2, 1fr);
      }
      .sub-card {
        padding: 15px;
      }
      .sub-card h3 { font-size: 1rem; }
      .sub-card p { font-size: 0.8rem; }
    }

    /* Toast styles */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #58cc02;
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 10px;
      transform: translateY(100px);
      opacity: 0;
      transition: transform 0.3s, opacity 0.3s;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    /* Fixed Back button positioning */
    .back-button-container {
      position: fixed;
      top: 15px;
      left: 15px;
      z-index: 1000;
    }

    .back-button-container .btn {
      margin: 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      background: linear-gradient(to right, #58cc02, #1cb0f6);
      border: none;
      color: white;
      padding: 10px 20px;
      border-radius: 50px;
      font-family: 'Baloo 2', cursive;
      cursor: pointer;
      display: inline-block !important;
      position: relative;
      z-index: 1001;
    }

    /* Main content area */
    #learning-content {
      padding-top: 60px;
      position: relative;
      z-index: 1;
    }

    @media (max-width: 600px) {
      .back-button-container {
        top: 10px;
        left: 10px;
      }
      
      .back-button-container .btn {
        padding: 8px 16px;
        font-size: 0.9rem;
      }
      
      #learning-content {
        padding-top: 50px;
      }
    }

    * {
      box-sizing: border-box;
    }

    /* Section header buttons */
    .section-header {
      display: flex;
      justify-content: flex-start;
      margin-bottom: 20px;
      padding-left: 10px;
    }

    /* Sound button styles */
    .sound-btn {
      background: #ff9f43;
      border: none;
      color: white;
      padding: 8px 15px;
      border-radius: 50px;
      cursor: pointer;
      margin: 5px;
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .sound-btn:hover {
      background: #ff7f00;
    }

    .sound-btn:active {
      transform: scale(0.96);
    }

    /* Tone indicators */
    .tone-indicator {
      display: inline-block;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      text-align: center;
      line-height: 20px;
      font-size: 0.8rem;
      margin: 0 2px;
      color: white;
    }

    .tone-1 { background-color: #ff6b6b; }
    .tone-2 { background-color: #4ecdc4; }
    .tone-3 { background-color: #ffe66d; color: #333; }
    .tone-4 { background-color: #1a535c; }

    /* Pinyin display for numbers */
    .pinyin-display {
      font-size: 1.1rem;
      color: #ff6b6b;
      margin: 5px 0;
    }

    /* Initials and Finals categorization */
    .category-title {
      text-align: left;
      margin: 20px 0 10px;
      padding-left: 10px;
      color: #1cb0f6;
      font-family: 'Baloo 2', cursive;
    }

    /* Number pagination */
    .pagination {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 20px 0;
      flex-wrap: wrap;
    }

    .page-btn {
      background: #e0e0e0;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
    }

    .page-btn.active {
      background: #58cc02;
      color: white;
    }
  </style>
</head>
<body>
<div id="app">
  <div class="back-button-container">
    <button id="globalBack" class="btn" onclick="goBack()">Back</button>
  </div>
  <div id="learning-content"></div>
</div>

<div id="achievementToast" class="toast">
  <i class="fas fa-trophy"></i>
  <div>
    <div id="toastTitle">成就解锁! Achievement Unlocked!</div>
    <div id="toastDesc">You've earned a new badge.</div>
  </div>
</div>

<script>
/* === Chinese Pinyin Data === */
// Initials (声母)
const INITIALS = [
  {pinyin: "b", example: "爸爸 bàba (Father)", char: "爸"},
  {pinyin: "p", example: "苹果 píngguǒ (Apple)", char: "苹"},
  {pinyin: "m", example: "妈妈 māma (Mother)", char: "妈"},
  {pinyin: "f", example: "飞机 fēijī (Airplane)", char: "飞"},
  {pinyin: "d", example: "大 dà (Big)", char: "大"},
  {pinyin: "t", example: "他 tā (He)", char: "他"},
  {pinyin: "n", example: "你 nǐ (You)", char: "你"},
  {pinyin: "l", example: "来 lái (Come)", char: "来"},
  {pinyin: "g", example: "哥 gē (Older brother)", char: "哥"},
  {pinyin: "k", example: "看 kàn (Look)", char: "看"},
  {pinyin: "h", example: "好 hǎo (Good)", char: "好"},
  {pinyin: "j", example: "家 jiā (Home)", char: "家"},
  {pinyin: "q", example: "去 qù (Go)", char: "去"},
  {pinyin: "x", example: "小 xiǎo (Small)", char: "小"},
  {pinyin: "zh", example: "这 zhè (This)", char: "这"},
  {pinyin: "ch", example: "吃 chī (Eat)", char: "吃"},
  {pinyin: "sh", example: "是 shì (Is)", char: "是"},
  {pinyin: "r", example: "人 rén (Person)", char: "人"},
  {pinyin: "z", example: "在 zài (At)", char: "在"},
  {pinyin: "c", example: "菜 cài (Vegetable)", char: "菜"},
  {pinyin: "s", example: "三 sān (Three)", char: "三"},
  {pinyin: "y", example: "一 yī (One)", char: "一"},
  {pinyin: "w", example: "我 wǒ (I)", char: "我"}
];

// Finals (韵母)
const FINALS = [
  {pinyin: "a", example: "啊 a (Ah)", char: "啊", tone: 1},
  {pinyin: "o", example: "哦 ó (Oh)", char: "哦", tone: 2},
  {pinyin: "e", example: "饿 è (Hungry)", char: "饿", tone: 4},
  {pinyin: "i", example: "一 yī (One)", char: "一", tone: 1},
  {pinyin: "u", example: "五 wǔ (Five)", char: "五", tone: 3},
  {pinyin: "ü", example: "鱼 yú (Fish)", char: "鱼", tone: 2},
  {pinyin: "ai", example: "爱 ài (Love)", char: "爱", tone: 4},
  {pinyin: "ei", example: "飞 fēi (Fly)", char: "飞", tone: 1},
  {pinyin: "ao", example: "好 hǎo (Good)", char: "好", tone: 3},
  {pinyin: "ou", example: "狗 gǒu (Dog)", char: "狗", tone: 3},
  {pinyin: "an", example: "看 kàn (Look)", char: "看", tone: 4},
  {pinyin: "en", example: "人 rén (Person)", char: "人", tone: 2},
  {pinyin: "ang", example: "上 shàng (Up)", char: "上", tone: 4},
  {pinyin: "eng", example: "风 fēng (Wind)", char: "风", tone: 1},
  {pinyin: "ong", example: "中 zhōng (Middle)", char: "中", tone: 1},
  {pinyin: "ia", example: "家 jiā (Home)", char: "家", tone: 1},
  {pinyin: "iao", example: "小 xiǎo (Small)", char: "小", tone: 3},
  {pinyin: "ie", example: "写 xiě (Write)", char: "写", tone: 3},
  {pinyin: "iu", example: "六 liù (Six)", char: "六", tone: 4},
  {pinyin: "ian", example: "天 tiān (Sky)", char: "天", tone: 1},
  {pinyin: "in", example: "新 xīn (New)", char: "新", tone: 1},
  {pinyin: "iang", example: "想 xiǎng (Think)", char: "想", tone: 3},
  {pinyin: "ing", example: "听 tīng (Listen)", char: "听", tone: 1},
  {pinyin: "iong", example: "熊 xióng (Bear)", char: "熊", tone: 2},
  {pinyin: "ua", example: "花 huā (Flower)", char: "花", tone: 1},
  {pinyin: "uo", example: "国 guó (Country)", char: "国", tone: 2},
  {pinyin: "uai", example: "快 kuài (Fast)", char: "快", tone: 4},
  {pinyin: "ui", example: "水 shuǐ (Water)", char: "水", tone: 3},
  {pinyin: "uan", example: "玩 wán (Play)", char: "玩", tone: 2},
  {pinyin: "un", example: "云 yún (Cloud)", char: "云", tone: 2},
  {pinyin: "uang", example: "光 guāng (Light)", char: "光", tone: 1},
  {pinyin: "ueng", example: "翁 wēng (Old man)", char: "翁", tone: 1},
  {pinyin: "üe", example: "月 yuè (Moon)", char: "月", tone: 4},
  {pinyin: "üan", example: "远 yuǎn (Far)", char: "远", tone: 3},
  {pinyin: "ün", example: "云 yún (Cloud)", char: "云", tone: 2}
];

// Generate numbers 1-100 with Chinese characters and Pinyin
function generateChineseNumbers() {
  const numbers = [];
  const digits = ["", "一", "二", "三", "四", "五", "六", "七", "八", "九", "十"];
  const pinyinDigits = ["", "yī", "èr", "sān", "sì", "wǔ", "liù", "qī", "bā", "jiǔ", "shí"];
  const tones = ["", "1", "4", "1", "4", "3", "4", "1", "1", "3", "2"];
  
  for (let i = 1; i <= 100; i++) {
    let chinese = "";
    let pinyin = "";
    let tonePattern = "";
    
    if (i <= 10) {
      chinese = digits[i];
      pinyin = pinyinDigits[i];
      tonePattern = tones[i];
    } else if (i < 20) {
      chinese = "十" + (i % 10 !== 0 ? digits[i % 10] : "");
      pinyin = "shí " + (i % 10 !== 0 ? pinyinDigits[i % 10] : "");
      tonePattern = "2" + (i % 10 !== 0 ? "," + tones[i % 10] : "");
    } else if (i < 100) {
      const tens = Math.floor(i / 10);
      const ones = i % 10;
      chinese = digits[tens] + "十" + (ones !== 0 ? digits[ones] : "");
      pinyin = pinyinDigits[tens] + " shí " + (ones !== 0 ? pinyinDigits[ones] : "");
      tonePattern = tones[tens] + ",2" + (ones !== 0 ? "," + tones[ones] : "");
    } else if (i === 100) {
      chinese = "一百";
      pinyin = "yī bǎi";
      tonePattern = "1,3";
    }
    
    numbers.push({
      digit: i,
      chinese: chinese,
      pinyin: pinyin,
      tone: tonePattern
    });
  }
  
  return numbers;
}

const CHINESE_NUMBERS = generateChineseNumbers();

// Track current view state
let currentView = 'level1';
let currentNumberPage = 0;
const NUMBERS_PER_PAGE = 20;

/* === Init === */
document.addEventListener('DOMContentLoaded', loadLevel1);

/* === Navigation Functions === */
function goBack() {
  switch(currentView) {
    case 'initials-menu':
    case 'finals-menu':
    case 'numbers-menu':
    case 'level2':
    case 'level3':
    case 'games':
      loadLevel1();
      break;
    case 'initial-lesson':
      loadInitialsMenu();
      break;
    case 'final-lesson':
      loadFinalsMenu();
      break;
    case 'number-lesson':
      loadNumbersMenu();
      break;
    case 'level1':
    default:
      window.location.href = 'welcome.html';
  }
}

/* Show sub-menu: Pinyin & Numbers */
function loadLevel1(){
  currentView = 'level1';
  toggleGlobalBack(false);
  document.getElementById("learning-content").innerHTML = `
<h2>Progress Tracking</h2>
<div class="sub-container">
  <div class="sub-card" onclick="window.location.href='chprogress.html'">
    <h3>My Progress</h3><p>Track your learning journey</p>
  </div>
</div>

    <h2>Level 1: Pinyin & Numbers</h2>
    <div class="sub-container">
      <div class="sub-card" onclick="loadInitialsMenu()">
        <h3>Initials</h3><p>Learn Chinese initials</p>
      </div>
      <div class="sub-card" onclick="loadFinalsMenu()">
        <h3>Finals</h3><p>Learn Chinese finals with tones</p>
      </div>
      <div class="sub-card" onclick="loadNumbersMenu()">
        <h3>Numbers</h3><p>Learn Chinese numbers 1-100 with Pinyin</p>
      </div>
    </div>

    <h2>Level 2: Basic Words</h2>
<div class="sub-container">
  <div class="sub-card" onclick="goToLevel2('fruits')">
    <h3>Fruits</h3><p>Learn names of fruits</p>
  </div>
  <div class="sub-card" onclick="goToLevel2('vegetables')">
    <h3>Vegetables</h3><p>Learn names of vegetables</p>
  </div>
  <div class="sub-card" onclick="goToLevel2('animals')">
    <h3>Animals</h3><p>Learn about animals</p>
  </div>
  <div class="sub-card" onclick="goToLevel2('nature')">
    <h3>Nature</h3><p>Learn nature-related words</p>
  </div>
</div>


<h2>Level 3: Sentences & Expressions</h2>
<div class="sub-container">
  <div class="sub-card" onclick="goToLevel3('greetings')">
    <h3>Simple Greetings</h3><p>Hello, Guten Morgen...</p>
  </div>
  <div class="sub-card" onclick="goToLevel3('activities')">
    <h3>Daily Activities</h3><p>I eat, I play, I sleep...</p>
  </div>
</div>

<h2>Games</h2>
<div class="sub-container">
  <div class="sub-card" onclick="playGame('yes-no')">
    <h3>Yes or No</h3>
    <p>Practice by choosing Yes or No</p>
  </div>
  <div class="sub-card" onclick="playGame('count-apples')">
    <h3>Count the Apples</h3>
    <p>Counting apples in pictures</p>
  </div>
</div>

  `;
}

/* === Initials, Finals, Numbers Menu and Lesson Functions === */
function loadInitialsMenu(){
  currentView = 'initials-menu';
  toggleGlobalBack(true);
  document.getElementById("learning-content").innerHTML = `
    <div class="section-header">
      <button class="btn" onclick="startInitialLesson(0)">Learn Initials</button>
    </div>
    <div class="initials-grid">
      ${INITIALS.map((initial, index)=>`
        <div class="initial-card" onclick="startInitialLesson(${index})">
          <div class="main-char">${initial.pinyin}</div>
          <div class="example">${initial.example}</div>
        </div>`).join("")}
    </div>
  `;
}

function startInitialLesson(index){
  currentView = 'initial-lesson';
  toggleGlobalBack(true);
  
  if(index < 0){ index = 0; }
  if(index >= INITIALS.length){ loadInitialsMenu(); return; }
  const initial = INITIALS[index];

  // Track progress for initial learning
  if (typeof updateProgress === 'function') {
    updateProgress('level1', 'initials', 0.1);
  }

  document.getElementById("learning-content").innerHTML = `
    <div class="lesson-container">
      <div class="main-char">${initial.pinyin}</div>
      <div class="example">${initial.example}</div>
      <button class="sound-btn" onclick="playInitialSound('${initial.pinyin}')">
        <i class="fas fa-volume-up"></i>Hear Pronunciation
      </button>
      <div class="trace-area">
        <canvas id="traceCanvas" width="250" height="250"></canvas>
        <button class="btn clear-btn" onclick="clearCanvas()">Clear</button>
      </div>
      <div class="lesson-controls">
        <button class="btn" onclick="startInitialLesson(${index-1})">Previous</button>
        <button class="btn" onclick="startInitialLesson(${index+1})">Next</button>
      </div>
    </div>
  `;
  initCanvas();
}

function loadFinalsMenu(){
  currentView = 'finals-menu';
  toggleGlobalBack(true);

  document.getElementById("learning-content").innerHTML=`
    <div class="section-header">
      <button class="btn" onclick="startFinalLesson(0)">Learn Finals</button>
    </div>
    <h3 class="category-title">Simple Finals</h3>
    <div class="finals-grid">
      ${FINALS.slice(0, 6).map((final, index)=>`
        <div class="final-card" onclick="startFinalLesson(${index})">
          <div class="main-char">${final.pinyin}</div>
          <div class="small-char">${final.char} <span class="tone-indicator tone-${final.tone}">${final.tone}</span></div>
          <div class="example">${final.example}</div>
        </div>`).join("")}
    </div>
    
    <h3 class="category-title">Compound Finals</h3>
    <div class="finals-grid">
      ${FINALS.slice(6, 15).map((final, index)=>`
        <div class="final-card" onclick="startFinalLesson(${index+6})">
          <div class="main-char">${final.pinyin}</div>
          <div class="small-char">${final.char} <span class="tone-indicator tone-${final.tone}">${final.tone}</span></div>
          <div class="example">${final.example}</div>
        </div>`).join("")}
    </div>
    
    <h3 class="category-title">Nasal Finals</h3>
    <div class="finals-grid">
      ${FINALS.slice(15).map((final, index)=>`
        <div class="final-card" onclick="startFinalLesson(${index+15})">
          <div class="main-char">${final.pinyin}</div>
          <div class="small-char">${final.char} <span class="tone-indicator tone-${final.tone}">${final.tone}</span></div>
          <div class="example">${final.example}</div>
        </div>`).join("")}
    </div>
  `;
}

function startFinalLesson(index){
  currentView = 'final-lesson';
  toggleGlobalBack(true);

  if(index < 0){ index = 0; }
  if(index >= FINALS.length){ loadFinalsMenu(); return; }
  const final = FINALS[index];

  // Track progress for final learning
  if (typeof updateProgress === 'function') {
    updateProgress('level1', 'finals', 0.1);
  }
  
  document.getElementById("learning-content").innerHTML = `
    <div class="lesson-container">
      <div class="main-char">${final.pinyin}</div>
      <div class="small-char">${final.char} <span class="tone-indicator tone-${final.tone}">${final.tone}</span></div>
      <div class="example">${final.example}</div>
      
      <div class="lesson-controls">
        <button class="sound-btn" onclick="playFinalSound('${final.pinyin}', ${final.tone})">
          <i class="fas fa-volume-up"></i>Hear Pronunciation
        </button>
      </div>
      
      <div class="trace-area">
        <canvas id="traceCanvas" width="250" height="250"></canvas>
        <button class="btn clear-btn" onclick="clearCanvas()">Clear</button>
      </div>
      <div class="lesson-controls">
        <button class="btn" onclick="startFinalLesson(${index-1})">Previous</button>
        <button class="btn" onclick="startFinalLesson(${index+1})">Next</button>
      </div>
    </div>
  `;
  
  initCanvas();
}

function loadNumbersMenu(){
  currentView = 'numbers-menu';
  toggleGlobalBack(true);
  
  const startIndex = currentNumberPage * NUMBERS_PER_PAGE;
  const endIndex = Math.min(startIndex + NUMBERS_PER_PAGE, CHINESE_NUMBERS.length);
  const totalPages = Math.ceil(CHINESE_NUMBERS.length / NUMBERS_PER_PAGE);
  
  let paginationHTML = '';
  for (let i = 0; i < totalPages; i++) {
    const startNum = i * NUMBERS_PER_PAGE + 1;
    const endNum = Math.min((i + 1) * NUMBERS_PER_PAGE, CHINESE_NUMBERS.length);
    paginationHTML += `
      <button class="page-btn ${i === currentNumberPage ? 'active' : ''}" 
              onclick="changeNumberPage(${i})">
        ${startNum}-${endNum}
      </button>
    `;
  }

  document.getElementById("learning-content").innerHTML=`
    <div class="section-header">
      <button class="btn" onclick="startNumberLesson(0)">Learn Numbers</button>
    </div>
    
    <div class="pagination">
      ${paginationHTML}
    </div>
    
    <div class="numbers-grid">
      ${CHINESE_NUMBERS.slice(startIndex, endIndex).map((n, index)=>`
        <div class="number-card" onclick="startNumberLesson(${startIndex + index})">
          <div class="main-char">${n.digit}</div>
          <div class="small-char">${n.chinese}</div>
          <div class="pinyin-display">${n.pinyin}</div>
        </div>`).join("")}
    </div>
    
    
  `;
}

function changeNumberPage(page) {
  currentNumberPage = page;
  loadNumbersMenu();
}

function startNumberLesson(index){
  currentView = 'number-lesson';
  toggleGlobalBack(true);

  if(index < 0){ index = 0; }
  if(index >= CHINESE_NUMBERS.length){ loadNumbersMenu(); return; }
  const n = CHINESE_NUMBERS[index];

  // Track progress for number learning
  if (typeof updateProgress === 'function') {
    updateProgress('level1', 'numbers', 0.1);
  }
  
  // Create tone indicators for numbers with multiple syllables
  let toneIndicators = '';
  if (typeof n.tone === 'string' && n.tone.includes(',')) {
    const tones = n.tone.split(',');
    const pinyinParts = n.pinyin.split(' ');
    toneIndicators = pinyinParts.map((part, i) => 
      `<span class="tone-indicator tone-${tones[i]}">${tones[i]}</span>`
    ).join(' ');
  } else {
    toneIndicators = `<span class="tone-indicator tone-${n.tone}">${n.tone}</span>`;
  }
  
  document.getElementById("learning-content").innerHTML = `
    <div class="lesson-container">
      <div class="main-char">${n.digit}</div>
      <div class="example">${n.chinese}</div>
      <div class="pinyin-display">${n.pinyin} ${toneIndicators}</div>
      <button class="sound-btn" onclick="playNumberSound(${index})">
        <i class="fas fa-volume-up"></i>Hear Number
      </button>
      <div class="trace-area">
        <canvas id="traceCanvas" width="250" height="250"></canvas>
        <button class="btn clear-btn" onclick="clearCanvas()">Clear</button>
      </div>
      <div class="lesson-controls">
        <button class="btn" onclick="startNumberLesson(${index-1})">Previous</button>
        <button class="btn" onclick="startNumberLesson(${index+1})">Next</button>
      </div>
    </div>
  `;
  
  initCanvas();
}

/* === Sound Functions === */
function playInitialSound(initial) {
  if ('speechSynthesis' in window) {
    const utterance = new SpeechSynthesisUtterance(initial);
    utterance.rate = 0.7;
    speechSynthesis.speak(utterance);
  } else {
    alert("Your browser doesn't support text-to-speech. Please try a modern browser like Chrome or Edge.");
  }
}

function playFinalSound(pinyin, tone) {
  if ('speechSynthesis' in window) {
    const utterance = new SpeechSynthesisUtterance(pinyin);
    utterance.rate = 0.7;
    utterance.pitch = 1.0 + (tone * 0.1);
    speechSynthesis.speak(utterance);
  } else {
    alert("Your browser doesn't support text-to-speech. Please try a modern browser like Chrome or Edge.");
  }
}

function playNumberSound(index) {
  const n = CHINESE_NUMBERS[index];
  
  if ('speechSynthesis' in window) {
    const utterance = new SpeechSynthesisUtterance(n.pinyin);
    utterance.rate = 0.8;
    speechSynthesis.speak(utterance);
  } else {
    alert("Your browser doesn't support text-to-speech. Please try a modern browser like Chrome or Edge.");
  }
}

/* === Tracing Canvas === */
function initCanvas(){
  const canvas=document.getElementById("traceCanvas");
  const ctx=canvas.getContext("2d");
  ctx.lineWidth=4; ctx.lineCap="round"; ctx.strokeStyle="#58cc02";
  let drawing=false;
  function getPos(e){
    const rect=canvas.getBoundingClientRect();
    return {x:(e.clientX||e.touches[0].clientX)-rect.left,y:(e.clientY||e.touches[0].clientY)-rect.top};
  }
  canvas.onmousedown=()=>drawing=true;
  canvas.onmouseup=()=>{drawing=false;ctx.beginPath();};
  canvas.onmousemove=e=>{if(!drawing)return; const p=getPos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(p.x,p.y);}
  canvas.ontouchstart=()=>drawing=true;
  canvas.ontouchend=()=>{drawing=false;ctx.beginPath();};
  canvas.ontouchmove=e=>{e.preventDefault(); if(!drawing)return; const p=getPos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(p.x,p.y);}
}

function toggleGlobalBack(show) {
  const btn = document.getElementById("globalBack");
  if (!btn) return;
  btn.style.display = show ? "inline-block" : "none";
}

function clearCanvas(){
  const canvas = document.getElementById("traceCanvas");
  if (canvas) {
    const ctx = canvas.getContext("2d");
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  }
}

/* === Navigate to Level 2/3/Game Pages === */
function goToLevel2(category){
  window.location.href = `chlevel2.html?category=${category}`;
}

function goToLevel3(category){
  window.location.href = `chlevel3.html?category=${category}`;
}

function playGame(gameType){
  // Redirect to chgames.html with a query parameter to identify the game
  window.location.href = `chgames.html?game=${gameType}`;
}
</script>
<script src="script.js"></script>
<script src="chprogress.js"></script>

</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#58CC02">
  <title>LinguaKids - Level 3</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@600;700&family=Quicksand:wght@400;500;600&display=swap" rel="stylesheet">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <style>
    body, html { margin: 0; padding: 0; font-family: 'Quicksand', sans-serif; background:#f6f8ff; }
    h2 { text-align:center; color:#58cc02; font-family:'Baloo 2', cursive; }
    .item-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px auto; padding: 0 15px; max-width: 1000px; }
    .item-card { background: white; padding: 15px; border-radius: 12px; text-align: center; box-shadow: 0 4px 8px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s; }
    .item-card:hover { transform: translateY(-4px); }
    .question { font-weight: bold; color: #1cb0f6; margin-bottom: 8px; }
    .answer { margin-bottom: 10px; color: #333; }
    .speak-btn { background: linear-gradient(to right,#58cc02,#1cb0f6); border: none; color: white; padding: 6px 12px; border-radius: 50px; cursor: pointer; font-size: 0.9rem; font-family: 'Baloo 2', cursive; margin: 4px; }
    .speak-btn:hover { opacity: 0.9; }
    .btn { background: linear-gradient(to right,#58cc02,#1cb0f6); border: none; color: white; padding: 8px 20px; border-radius: 50px; font-family: 'Baloo 2', cursive; cursor: pointer; margin: 10px 5px; }
    .btn:active { transform: scale(0.96); }
    @media (max-width: 600px) { .item-grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <button onclick="goBack()" class="btn">Back</button>
  <h2 id="categoryTitle"></h2>
  <div id="content" class="item-grid"></div>

<script>
// ===== PAGE-SPECIFIC DATA AND FUNCTIONS =====

const DATA = {
  greetings: [
    { q: "Hello!", a: "Hello! ğŸ‘‹" },
    { q: "Good morning", a: "Good morning! â˜€ï¸" },
    { q: "Good afternoon", a: "Good afternoon! ğŸŒ" },
    { q: "Good evening", a: "Good evening! ğŸŒ™" },
    { q: "Good night", a: "Good night! ğŸŒœ" },
    { q: "How are you?", a: "I'm fine, thank you! ğŸ˜Š" },
    { q: "What's your name?", a: "My name is [Your Name]." },
    { q: "Nice to meet you", a: "Nice to meet you too! ğŸ¤" },
    { q: "See you later", a: "See you! ğŸ‘‹" },
    { q: "Thank you", a: "You're welcome! ğŸ˜Š" },

    // NEW GREETINGS
    { q: "Hi there!", a: "Hi! ğŸ‘‹" },
    { q: "How's your day?", a: "My day is good! ğŸ˜„" },
    { q: "Long time no see", a: "Yes! It's been a while! ğŸ˜Š" },
    { q: "May I come in?", a: "Yes, please come in! ğŸšª" },
    { q: "Have a nice day", a: "You too! ğŸŒˆ" },
    { q: "Goodbye", a: "Goodbye! ğŸ‘‹" },
    { q: "Take care", a: "I will! â¤ï¸" }
  ],

  activities: [
    { q: "I eat food ğŸ" },
    { q: "I go to school ğŸ«" },
    { q: "I play with friends ğŸ‘«" },
    { q: "I read books ğŸ“š" },
    { q: "I watch TV ğŸ“º" },
    { q: "I help my mom ğŸ‘©" },
    { q: "I take a bath ğŸ›" },
    { q: "I brush my teeth ğŸ¦·" },
    { q: "I sleep at night ğŸ˜´" },
    { q: "I drink water ğŸ’§" },

    // NEW ACTIVITIES
    { q: "I draw pictures ğŸ¨" },
    { q: "I ride my bicycle ğŸš²" },
    { q: "I play games ğŸ®" },
    { q: "I sing songs ğŸ¤" },
    { q: "I dance ğŸ’ƒ" },
    { q: "I clean my room ğŸ§¹" },
    { q: "I cook with my mom ğŸ³" },
    { q: "I water the plants ğŸŒ±" },
    { q: "I play in the park ğŸŒ³" },
    { q: "I feed my pet ğŸ¶" }
  ],

  questions: [
    { q: "What is your name?", a: "My name is John." },
    { q: "How old are you?", a: "I am 6 years old." },
    { q: "Where do you live?", a: "I live in India." },
    { q: "Do you like fruits?", a: "Yes, I like apples." },
    { q: "What is this?ğŸ", a: "This is an apple." },

    // NEW QUESTIONS
    { q: "What is your favorite color?", a: "My favorite color is blue." },
    { q: "What did you eat today?", a: "I ate rice and vegetables." },
    { q: "Do you have a pet?", a: "Yes, I have a dog." },
    { q: "What do you like to do?", a: "I like to play and draw." },
    { q: "Where are you going?", a: "I am going to school." },
    { q: "Are you happy?", a: "Yes, I am very happy! ğŸ˜„" },
    { q: "What time do you sleep?", a: "I sleep at 9 PM." },
    { q: "Who is your best friend?", a: "My best friend is [Friend's Name]." },
    { q: "What is your favorite food?", a: "My favorite food is pizza." },
    { q: "Can you help me?", a: "Yes, I can help you!" }
  ]
};


// Track which items have been interacted with in this session
const interactedItems = new Set();
let currentCategory = null;

function getCategory(){ 
  const urlParams = new URLSearchParams(window.location.search);
  const category = urlParams.get("category");
  console.log("Retrieved category from URL:", category);
  return category;
}

function loadCategory(){
  const cat = getCategory();
  console.log("Loading category:", cat, "Current category:", currentCategory);
  
  // Only reload if category changed
  if (cat === currentCategory) {
    console.log("Same category, no reload needed");
    return;
  }
  
  currentCategory = cat;
  
  if (!cat || !DATA[cat]) { 
    document.getElementById("content").innerHTML = "<p>Category not found.</p>"; 
    return; 
  }
  
  document.getElementById("categoryTitle").textContent = `Category: ${cat.charAt(0).toUpperCase() + cat.slice(1)}`;
  
  document.getElementById("content").innerHTML = DATA[cat].map((item, index) => `
    <div class="item-card" onclick="handleSpeak('${cat}', ${index}, 'question')">
      <div class="question">Q: ${item.q}</div>
      ${item.a ? `<div class="answer">A: ${item.a}</div>` : ""}
      <button class="speak-btn" onclick="handleSpeak('${cat}', ${index}, 'question', event)">ğŸ”Š Question</button>
      ${item.a ? `<button class="speak-btn" onclick="handleSpeak('${cat}', ${index}, 'answer', event)">ğŸ”Š Answer</button>` : ""}
    </div>`).join("");
  
  console.log(`Loaded ${DATA[cat].length} items for category: ${cat}`);
}

/**
 * Enhanced: Track progress only once per item per session
 */
function handleSpeak(category, index, type, event) {
  if (event) {
    event.stopPropagation();
  }
  
  const item = DATA[category][index];
  const textToSpeak = (type === 'question') ? item.q : item.a;

  if (textToSpeak) {
    // Create unique identifier for this item
    const itemKey = `${category}_${index}`;
    
    // Only track progress if this is the first interaction with this item in current session
    if (!interactedItems.has(itemKey)) {
      interactedItems.add(itemKey);
      
      // Update progress - track each unique item once
      if (typeof updateProgress === 'function') {
        const success = updateProgress('level3', category, index);
        if (success) {
          console.log(`Progress tracked for: ${category} item ${index}`);
        }
      }
    }
    
    speak(textToSpeak);
  }
}

/**
 * Simplified speak function - progress tracking is handled above
 */
function speak(text){
  // Clean the text for speech (remove emojis and special characters)
  const cleanText = text.replace(/[^\w\s]/gi, ' ').trim();
  
  if ('speechSynthesis' in window) {
    const utterance = new SpeechSynthesisUtterance(cleanText);
    utterance.lang = "en-US";
    utterance.rate = 0.8; // Slightly slower for kids
    utterance.pitch = 1.2; // Slightly higher pitch for engagement
    
    speechSynthesis.speak(utterance);
  } else {
    console.log("Speech synthesis not supported");
  }
}

function goBack(){ 
  window.location.href = "english.html"; 
}

// Force reload when page is shown (for back/forward navigation)
function handleVisibilityChange() {
  if (!document.hidden) {
    console.log("Page became visible, checking if reload is needed");
    loadCategory();
  }
}

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
  console.log("Level 3 page loaded");
  
  // Add visibility change listener
  document.addEventListener('visibilitychange', handleVisibilityChange);
  
  // Add page show listener (for back/forward cache)
  window.addEventListener('pageshow', function(event) {
    console.log("Page show event, persisted:", event.persisted);
    if (event.persisted) {
      loadCategory();
    }
  });
  
  if (typeof initProgress === 'function') { 
    initProgress(); 
  }
  loadCategory();
});

// Also load category when window loads (as backup)
window.addEventListener('load', function() {
  console.log("Window load event");
  loadCategory();
});
</script>

<script src="progress.js"></script>
<script src="script.js"></script>

</body>
</html>